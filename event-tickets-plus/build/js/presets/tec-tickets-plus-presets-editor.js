tribe.tickets.editor=tribe.tickets.editor||{},function(e,t){"use strict";t.selectors={presetSection:"#tec-tickets-plus-presets",presetSectionActive:"active",editButton:"#tec-tickets-plus-presets-edit",cancelButton:"#tec-tickets-plus-presets-cancel",ticketFormCancelButton:"#tribe_settings_form_cancel",presetSelector:"#ticket-preset",addButton:".tec-tickets-plus-presets__button-add",reviewButton:".tec-tickets-plus-presets__button-review",rsvpSaveButton:"#rsvp_form_save",rsvpNameHelp:'.tribe_soft_note.ticket_form_right[data-condition="Tribe__Tickets__RSVP"]',ticketFormSaveButton:"#ticket_form_save",ticketID:"#ticket_id",ticketForm:"#ticket_form",ticketNameField:"#ticket_name",ticketDescriptionField:"#ticket_description",ticketPriceField:"#ticket_price",ticketCapacityField:"#ticket_capacity",ticketCapacityModeField:"tribe-ticket[mode]",ticketIACField:"#ticket_iac",saveAsPresetCheckbox:"#tec-tickets-plus-preset__save-checkbox",saveAsPresetModalId:"tec-tickets-plus-preset-save-modal",saveAsPresetCloseButton:".tec-tickets-plus-preset-modal__close",modalSaveButton:"#tec-tickets-plus-preset-modal__save-button",modalCancelButton:"#tec-tickets-plus-preset-modal__cancel-button",previewTitle:".tec-tickets-plus-preset-modal__ticket-title",previewDescription:".tec-tickets-plus-preset-modal__ticket-description",previewAmount:".tec-tickets-plus-preset-modal__ticket-amount",previewCapacity:".tec-tickets-plus-preset-modal__ticket-capacity",hidden:"tribe-common-a11y-hidden"};var i=e(document.getElementById("tribetickets"));t.handleEditClick=function(i){i.preventDefault(),e(t.selectors.presetSection).removeClass(t.selectors.presetSectionActive),e(t.selectors.rsvpNameHelp).hide(),e(t.selectors.rsvpSaveButton).hide()},t.handleCancelClick=function(i){i.preventDefault(),e(t.selectors.ticketFormCancelButton).trigger("click")},t.handlePresetChange=function(i){i.preventDefault();const s=e(t.selectors.presetSelector).val();e(t.selectors.addButton).prop("disabled",""===s),e(t.selectors.reviewButton).prop("disabled",""===s)},t.handleAddClick=function(s){s.preventDefault();const c=e(t.selectors.presetSelector).val();c&&(i.trigger("spin.tribe","start"),t.getPreset(c).then((function(e){return t.applyPreset(e)})).then((function(){e(t.selectors.ticketFormSaveButton).trigger("click.tribe"),i.trigger("spin.tribe","stop")})).catch((function(e){console.error("Error getting or applying preset:",e),i.trigger("spin.tribe","stop")})))},t.handleReviewClick=function(s){s.preventDefault();const c=e(t.selectors.presetSelector).val();c&&(i.trigger("spin.tribe","start"),t.getPreset(c).then((function(s){t.applyPreset(s),e(t.selectors.rsvpNameHelp).hide(),e(t.selectors.rsvpSaveButton).hide(),i.trigger("spin.tribe","stop"),e(t.selectors.presetSection).removeClass(t.selectors.presetSectionActive)})).catch((function(e){console.error("Error getting preset:",e)})))},t.getPreset=function(t){const i={action:"tec_tickets_plus_get_preset",preset_id:t,nonce:tecTicketsPlusPresetEditor.nonce};return e.ajax({url:ajaxurl,type:"POST",data:i,dataType:"json"}).then((function(e){if(!e.success)throw new Error(e.data.message);return e.data}))},t.applyPreset=function(i){const s=e(t.selectors.ticketForm),c=i.data;if(!s.length)throw new Error("Ticket form not found");return s.find("#ticket_name").val(c.ticket_name),s.find("#ticket_description").val(c.description),s.find("#ticket_price").val(c.cost),t.handleCapacityData(c),(c.sale_start_logic||c.sale_end_logic)&&t.applySaleDates(c),t.handleAttendeeMetaData(c).then((function(){s.find("input, select, textarea").trigger("change")}))},t.handleCapacityData=function(i){if(!i.capacity||!i.capacity.type)return;const s=e(t.selectors.ticketForm),c="own"===i.capacity.type?"own":"",a=s.find('input[name="tribe-ticket[mode]"][value="'+c+'"]');a.prop("checked",!0).trigger("change"),"own"===i.capacity.type&&a.closest(".input_block").find('input[name="tribe-ticket[capacity]"]').val(i.capacity.amount)},t.handleAttendeeMetaData=function(t){e("#ticket_iac_setting_"+t.iac_setting).prop("checked",!0).trigger("change");const i={action:"tec_tickets_plus_render_saved_fields",nonce:tecTicketsPlusPresetEditor.nonce,attendeeMeta:t.iac};return e.ajax({url:ajaxurl,type:"POST",data:i,dataType:"json"}).then((function(t){if(!t.success)throw new Error(t.data.message);e(".tribe-tickets-attendee-saved-fields").hide(),e("#tribe-tickets-attendee-sortables").html(t.data)})).catch((function(e){throw console.error("Error handling attendee meta data:",e),e}))},t.getBaseDateTime=function(e,t,i){switch(e){case"start":return t;case"end":return i;case"now":return moment();default:return null}},t.calculateTargetDate=function(e,t){const i="before"===t.direction?"subtract":"add";return moment(e)[i](t.length,t.period)},t.setDateTimeFields=function(i,s){const c=e(t.selectors.ticketForm),a=c.find("#ticket_"+i+"_date"),n=c.find("#ticket_"+i+"_time"),o=a.datepicker("option","dateFormat"),r=e.datepicker.formatDate(o,s.toDate());a.val(r);const l=s.clone().subtract(15,"minutes");n.val(l.format("h:mma"))},t.applySaleDates=function(i){let s,c;const a=e("#EventStartDate").length>0;if(e("#EventEndDate").length>0&&a){const t=e("#EventStartDate").datepicker("getDate"),i=e("#EventEndDate").datepicker("getDate"),a=e("#EventStartTime").val(),n=e("#EventEndTime").val();if(s=moment(t),c=moment(i),a){const e=moment(a,"h:mma");e.isValid()&&s.set({hour:e.get("hour"),minute:e.get("minute"),second:0})}if(n){const e=moment(n,"h:mma");e.isValid()&&c.set({hour:e.get("hour"),minute:e.get("minute"),second:0})}}if(s&&c&&s.isValid()&&c.isValid()||(console.error("Invalid start or end date"),s=moment(),c=moment().add(24,"hours")),i.sale_start_logic){const e=i.sale_start_logic;switch(e.type){case"published":t.setDateTimeFields("start",moment());break;case"start":t.setDateTimeFields("start",s);break;case"relative":const i=t.getBaseDateTime(e.relative_to,s,c);if(i){const s=t.calculateTargetDate(i,e);t.setDateTimeFields("start",s)}}}if(i.sale_end_logic){const e=i.sale_end_logic;switch(e.type){case"start":t.setDateTimeFields("end",s);break;case"relative":const i=t.getBaseDateTime(e.relative_to,s,c);if(i){const s=t.calculateTargetDate(i,e);t.setDateTimeFields("end",s)}}}},t.handleSaveTicket=function(i){e(t.selectors.saveAsPresetCheckbox).is(":checked")&&(i.preventDefault(),i.stopPropagation(),t.showSaveAsPresetModal())},t.showSaveAsPresetModal=function(){const i=e(t.selectors.ticketForm),s=t.getCapacityInfo(),c={post_id:e("#post_ID").val(),ticket_id:i.find(t.selectors.ticketID).val(),ticket_name:i.find(t.selectors.ticketNameField).val(),ticket_description:i.find(t.selectors.ticketDescriptionField).val(),ticket_price:i.find(t.selectors.ticketPriceField).val(),ticket_capacity:-1===s.capacity?"Unlimited":`${s.capacity} available`,ticket_capacity_mode:s.mode,ticket_iac:i.find(t.selectors.ticketIACField).val()};e("#preset-name").val(c.ticket_name),e("#preset-cost").val(c.ticket_price),e(".tec-tickets-plus-preset-modal__ticket-id").val(c.ticket_id),e(t.selectors.previewTitle).html(c.ticket_name),e(t.selectors.previewDescription).html(c.ticket_description),e(t.selectors.previewAmount).html(c.ticket_price),e(t.selectors.previewCapacity).html(c.ticket_capacity),t.getFormattedPrice(c.post_id,c.ticket_id),document.getElementById(t.selectors.saveAsPresetModalId).showModal()},t.getCapacityInfo=function(){const t=e('input[name="tribe-ticket[mode]"]:checked').val();let i=-1;if("own"===t){const t=e('input[name="tribe-ticket[capacity]"]').filter((function(){return e(this).closest('[id$="_own_stock_block"]').length>0}));t.length&&!t.prop("disabled")&&(i=t.val())}return{mode:t,capacity:i}},t.showConfirmationDialog=function(e,t){const i=document.createElement("dialog");i.className="tec-tickets-plus-preset-modal__confirmation-dialog",i.innerHTML=`\n\t\t\t<p>${e}</p>\n\t\t\t<button class="button button-primary">OK</button>\n\t\t`,document.body.appendChild(i),i.showModal(),i.querySelector("button").addEventListener("click",(()=>{i.close(),i.remove(),"function"==typeof t&&t()}))},t.savePreset=function(){const i=e(document.getElementById(t.selectors.saveAsPresetModalId)).find("input, textarea, select").serializeArray(),s={};i.forEach((function(e){s[e.name]=e.value})),e.ajax({url:ajaxurl,type:"POST",data:{action:"tec_tickets_plus_save_as_preset",nonce:tecTicketsPlusPresetEditor.createNonce,...s},dataType:"json"}).then((function(e){e.success?(t.handleCloseModal(),t.showConfirmationDialog(e.data.message)):t.showConfirmationDialog(e.data.message)})).catch((function(e){console.error("Error saving preset:",e),t.showConfirmationDialog("Error saving preset. Please try again.")}))},t.resetModal=function(){const i=e(document.getElementById(t.selectors.saveAsPresetModalId));i.find(".tec-tickets-plus-preset__sale-type-select").each((function(){e(this).val(e(this).find("option:first").val()).trigger("change")})),i.find(".tec-tickets-plus-preset__sale-length").val(1),i.find(".tec-tickets-plus-preset__sale-period").each((function(){e(this).val("day")}));const s=i.find(".tec-tickets-plus-preset__sale-relative-to");s.length>=1&&(s.eq(0).val("now"),s.length>=2&&s.eq(1).val("end"))},t.handleCloseModal=function(){document.getElementById(t.selectors.saveAsPresetModalId).close(),t.resetModal(),e(document.getElementById(t.selectors.saveAsPresetModalId)).on("close",(function(){e(t.selectors.ticketFormSaveButton).on("click.tribe",(function(i){i.preventDefault(),i.stopPropagation(),e(t.selectors.ticketForm).submit()}))}))},t.handleCapacityTypeChange=function(i){const s=e(i.target),c=e(t.selectors.capacityAmountFieldContainer),a=e(t.selectors.capacityAmountField);"own"===s.val()?(c.show(),a.prop("required",!0)):(c.hide(),a.prop("required",!1),a.val("-1"))},t.getFormattedPrice=function(i,s){e.ajax({url:ajaxurl,type:"POST",data:{action:"tec_tickets_plus_preset_get_cost",nonce:tecTicketsPlusPresetEditor.createNonce,post_id:i,ticket_id:s}}).then((function(i){i.success&&e(t.selectors.previewAmount).html(i.data.price)})).catch((function(e){console.error("Error getting price format.",e)}))},t.initSalePeriodFields=function(){e(document.getElementById(t.selectors.saveAsPresetModalId)).find(".tec-tickets-plus-preset__sale-type-select").on("change",(function(){const i=e(this).closest(".tec-tickets-plus-preset__sale-date").find(".tec-tickets-plus-preset__sale-relative");"relative"===e(this).val()?i.removeClass(t.selectors.hidden):i.addClass(t.selectors.hidden)})).trigger("change")},t.init=function(){e(document).on("change",t.selectors.presetSelector,t.handlePresetChange).on("click",t.selectors.editButton,t.handleEditClick).on("click",t.selectors.cancelButton,t.handleCancelClick).on("click",t.selectors.addButton,t.handleAddClick).on("click",t.selectors.reviewButton,t.handleReviewClick).on("click",t.selectors.saveAsPresetCloseButton,t.handleCloseModal).on("change",t.selectors.capacityTypeField,t.handleCapacityTypeChange).on("click",t.selectors.modalSaveButton,t.savePreset).on("click",t.selectors.modalCancelButton,t.handleCloseModal),i.on("pre-save-ticket.tribe",(function(e){e.preventDefault(),e.stopPropagation(),t.handleSaveTicket(e)})),t.initSalePeriodFields()},e(document).ready(t.init)}(jQuery,tribe.tickets.editor),window.ticketsPlus=window.ticketsPlus||{},window.ticketsPlus.presets=window.ticketsPlus.presets||{},window.ticketsPlus.presets.tecTicketsPlusPresetsEditor={};