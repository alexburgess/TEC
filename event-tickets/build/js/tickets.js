(()=>{"use strict";const e=window.wp.hooks;void 0===tribe.tickets&&(tribe.tickets={}),"undefined"==typeof ajaxurl&&(ajaxurl=TribeTickets.ajaxurl),tribe.tickets.editor={};let t=window.ticketHeaderImage||{};!function(i,n,a,c){const r=n(document),o=n(document.getElementById("tribetickets")),d=".recurrence-row",s=".recurrence-row.tribe-recurrence-not-supported",l=".tribe-event-recurrence-rule",_="#rsvp_form_toggle, #ticket_form_toggle, #settings_form_toggle",p=document.body.classList.contains("tec-no-tickets-on-recurring"),u=".tec_ticket-panel__helper_text__wrap",k=".tec_ticket-panel__recurring-unsupported-warning";let m=null,f=null;if(0===o.length)return;const b=n(document.getElementById("event_tickets")),g=n(document.getElementById("post_ID")),y=n(document.getElementById("publish")),h=o.find(".tribe-tickets-editor-blocker"),v=o.find(".spinner");let w=n(document.getElementById("tribe_panel_base")),I=n(document.getElementById("tribe_panel_edit")),E=n(document.getElementById("tribe_panel_settings"));const x=["yy-mm-dd","m/d/yy","mm/dd/yy","d/m/yy","dd/mm/yy","m-d-yy","mm-dd-yy","d-m-yy","dd-mm-yy","yy.mm.dd","mm.dd.yy","dd.mm.yy"];let B=x[0];function D(e){void 0===e&&(e=!0);let t,i=o.find(".tribe-ticket-editor-field-default_provider");i.is(":radio")&&(i=i.filter(":checked")),t=e?"Tribe__Tickets__RSVP":"TEC\\Tickets\\Commerce\\Module",!e&&i.length>0&&(t=i.val());const a=n(document.getElementById("tec_tickets_ticket_provider"));!e&&a.val()||a.val(t),f=a.val(),a.trigger("change")}c.beforeUnload=function(e){let t=!1;return"true"===w.attr("aria-hidden")&&(t=tribe_global_stock_admin_ui.nav_away_msg),e.returnValue=t,t},t={uploader(){const e=wp.media({title:HeaderImageData.title,multiple:!1,library:{type:"image"},button:{text:HeaderImageData.button}});return e.on("close",(function(){const i=e.state().get("selection").toJSON();i.length&&t.render(i[0])})),e.open(),!1},render(e){n(document.getElementById("tribe_ticket_header_preview")).html(t.imgHTML(e)),n(document.getElementById("tribe_ticket_header_image_id")).val(e.id),n(document.getElementById("tribe_ticket_header_remove")).show(),n(document.getElementById("tribe_tickets_image_preview_filename")).show().find(".filename").text(e.filename)},imgHTML(e){let t='<img src="'+e.url+'" ';return t+='width="'+e.width+'" ',t+='height="'+e.height+'" ',t+="/>",t}},c.panels={list:"#tribe_panel_base",ticket:"#tribe_panel_edit",settings:"#tribe_panel_settings"},c.swapPanel=function(e){let t;D("rsvp"===m),t=e instanceof jQuery?e:void 0!==c.panels[e]?n(c.panels[e]):w;const a=n("#event_tickets");a.trigger("before_panel_swap.tickets",{panel:t}),o.find(".ticket_panel").each((function(){n(this).attr("aria-hidden","true")})),t.attr("aria-hidden","false"),t.is(w)?(n(i).off("beforeunload.tribe"),r.trigger("tribe.dependencies-run")):n(i).on("beforeunload.tribe",c.beforeUnload),a.trigger("after_panel_swap.tickets",{panel:t})},c.fetchPanels=function(e,t,i){i=i||"default",null==e?e={ticket_type:i}:e+="&ticket_type="+i;const a={action:"tribe-ticket-panels",notice:!1,post_id:g.val(),nonce:TribeTickets.add_ticket_nonce,data:e,is_admin:n("body").hasClass("wp-admin")};n.post(ajaxurl,a,(function(e){e.success&&c.refreshPanels(e.data,t)}),"json")},c.startWatchingMoveLinkIn=function(){b.find(".tribe-ticket-move-link").one("click",(function(){i.setTimeout(c.listentToThickboxEvents,250)}))},c.listentToThickboxEvents=function(){const e=n("#TB_window");0!==e.length&&e.one("tb_unload",(function(){c.fetchPanels(null,"list")}))},c.refreshPanels=function(t,i){w=n(t.list),I=n(t.ticket),E=n(t.settings),o.find(c.panels.list).replaceWith(w),o.find(c.panels.ticket).replaceWith(I),o.find(c.panels.settings).replaceWith(E),c.setupPanels(),c.swapPanel(i),n(".tribe-dependency").trigger("verify.dependency"),(0,e.doAction)("tec.tickets.admin.panels.refreshed",{panels:t,swapTo:i,tickets:o})},c.setupPanels=function(){i.MTAccordion({target:".accordion"});const e=n(document.getElementById("tribe-event-datepickers")),t=n(document.getElementById("ticket_start_date")),a=n(document.getElementById("ticket_end_date"));n(document.getElementById("ticket_start_time")),n(document.getElementById("ticket_end_time"));let c=0;document.getElementById("ticket_name_label");const r=n(document.getElementById("ticket_sale_start_date")),d=n(document.getElementById("ticket_sale_end_date"));if("undefined"==typeof tribe_datepicker_opts){const e=n("[data-datepicker_format]"),t=e.length?e.attr("data-datepicker_format"):"",a=parseInt(t,10);isNaN(a)||(i.tribe_datepicker_opts={dateFormat:x[a]})}const s=i.tribe_datepicker_opts||{};if(e.length&&e.data("startofweek"),"undefined"!=typeof tribe_ticket_datepicker_format){const e=(l=tribe_ticket_datepicker_format.datepicker_format_index,!isNaN(parseFloat(l))&&isFinite(l)?tribe_ticket_datepicker_format.datepicker_format_index:0);B=x[e]}else s&&s.dateFormat&&(B=s.dateFormat);var l;const _={dateFormat:B,showAnim:"fadeIn",changeMonth:!0,changeYear:!0,numberOfMonths:3,showButtonPanel:!1,onChange(){},beforeShow(e,t){t.input.data("prevDate",t.input.datepicker("getDate"));const i=n(t.dpDiv);i.addClass("tribe-ui-datepicker"),i.attrchange({trackValues:!0,callback(e){(e.newValue.indexOf("display: none")>=0||e.newValue.indexOf("display:none")>=0)&&i.removeClass("tribe-ui-datepicker")}})},onSelect(e,i){const c=n.datepicker.parseDate(B,e);switch(i.id){case"ticket_start_date":a.datepicker("option","minDate",c);break;case"ticket_end_date":t.datepicker("option","maxDate",c);break;case"ticket_sale_start_date":d.datepicker("option","minDate",c);break;case"ticket_sale_end_date":r.datepicker("option","maxDate",c)}}};n.extend(_,tribe_l10n_datatables.datepicker);const p=o.find(".tribe-timepicker:not(.ui-timepicker-input)");if(tribe_timepickers.setup_timepickers(p),t.datepicker(_).datepicker("option","defaultDate",n(document.getElementById("EventStartDate")).val()).on("keyup",(function(e){8!==e.keyCode&&46!==e.keyCode||n.datepicker._clearDate(this)})),a.datepicker(_).datepicker("option","defaultDate",n(document.getElementById("EventEndDate")).val()).on("keyup",(function(e){8!==e.keyCode&&46!==e.keyCode||n.datepicker._clearDate(this)})),r.datepicker(_).on("keyup",(function(e){8!==e.keyCode&&46!==e.keyCode||n.datepicker._clearDate(this)})),d.datepicker(_).on("keyup",(function(e){8!==e.keyCode&&46!==e.keyCode||n.datepicker._clearDate(this)})),n(document.getElementById("tribe_ticket_header_preview")).find("img").length){n(document.getElementById("tribe_ticket_header_remove")).show();const e=n(document.getElementById("tribe_ticket_header_preview")).find("img");e.removeAttr("width").removeAttr("height"),o.width()<e.width()&&e.css("width","95%")}"undefined"!=typeof tribe_event_tickets_plus&&n.isPlainObject(tribe_event_tickets_plus)&&n.isPlainObject(tribe_event_tickets_plus.meta)&&n.isPlainObject(tribe_event_tickets_plus.meta.admin)&&"function"==typeof tribe_event_tickets_plus.meta.admin.init_ticket_fields&&tribe_event_tickets_plus.meta.admin.init_ticket_fields(),tribe.tickets.table&&0!==w.find(".tribe-tickets-editor-table-tickets-body tr").length&&tribe.tickets.table.toggle_sortable(),o.find(tribe.validation.selectors.item).validation(),o.find(".tribe-dependent").dependency(),o.find(".tribe-dependency").trigger("verify.dependency")},r.ajaxSend((function(e,t,i){"string"===n.type(i.data)&&-1!==i.data.indexOf("action=tribe-ticket")&&o.trigger("spin.tribe","start")})),r.ajaxComplete((function(e,t,i){"string"===n.type(i.data)&&-1!==i.data.indexOf("action=tribe-ticket")&&o.trigger("spin.tribe","stop")})),r.on({"spin.tribe"(e,t){(void 0===t||n.inArray(t,["start","stop"]))&&(t="stop"),"stop"===t?(h.hide(),v.removeClass("is-active")):(h.show(),v.addClass("is-active"))}}),y.on("click",(function(e){n(i).off("beforeunload.tribe")})),r.on("click","#settings_form_toggle",(function(e){return e.preventDefault(),c.fetchPanels(null,"settings"),!1})),r.on("click","#capacity_form_toggle",(function(e){return e.preventDefault(),c.fetchPanels(null,"settings"),!1})),r.on("click","#tribe_settings_form_cancel, #ticket_form_cancel",(function(e){return e.preventDefault(),c.fetchPanels(null,"list"),!1})),r.on("click","#tribe_settings_form_save",(function(e){e.preventDefault();const t=E.find("input,textarea").serialize();return c.fetchPanels(t,"list"),!1})),r.on("click",".ticket_form_toggle",(function(e){e.preventDefault();const t=n(this),i="rsvp_form_toggle"===t.attr("id");return m=i?"rsvp":t.data("ticket-type"),D(i),I.find(".tribe-dependency").trigger("verify.dependency"),c.fetchPanels(null,"ticket",m),!1})),r.on("click",".ticket_edit_button",(function(e){e.preventDefault();const t=n(this);m=t.closest("[data-ticket-type]").data("ticket-type");const i={action:"tribe-ticket-edit",post_id:g.val(),ticket_id:t.data("ticketId"),nonce:TribeTickets.edit_ticket_nonce,is_admin:n("body").hasClass("wp-admin")};return n.post(ajaxurl,i,(function(t){t.success&&(c.refreshPanels(t.data,"ticket"),c.startWatchingMoveLinkIn("#event_tickets"),o.trigger("edit-ticket.tribe",e))}),"json"),!1})),r.on("click.tribe",'[name="ticket_form_save"]',(function(e){const t=n(document.getElementById("ticket_form_table"));let i=!0;if(t.trigger("validation.tribe"),tribe.validation.hasErrors(t))return;if(i=o.triggerHandler("additionalValidation.tribe",[i]),!1===i)return;o.trigger("pre-save-ticket.tribe",e);const a=I.find("#ticket_id").val(),r=w.find(`[data-ticket-type-id="${a}"]`).find(".tribe-ticket-field-order").val();let d=I.find("input,textarea,select").serialize().replace(/\'/g,"%27").replace(/\:/g,"%3A");d.includes("ticket_provider")||(d+="&ticket_provider="+encodeURIComponent(f));const s={action:"tribe-ticket-add",data:d,post_id:g.val(),nonce:TribeTickets.add_ticket_nonce,menu_order:r,is_admin:n("body").hasClass("wp-admin"),ticket_type:m};s.data=s.data.concat("&ticket_menu_order="+r),n.post(ajaxurl,s,(function(e){e.success&&c.refreshPanels(e.data)}),"json")})),r.on("click",".ticket_delete",(function(e){if(!confirm(tribe_ticket_notices.confirm_alert))return!1;e.preventDefault(),o.trigger("delete-ticket.tribe",e);const t=n(this).attr("attr-ticket-id"),i={action:"tribe-ticket-delete",post_id:g.val(),ticket_id:t,nonce:TribeTickets.remove_ticket_nonce,is_admin:n("body").hasClass("wp-admin")};n.post(ajaxurl,i,(function(e){e.success&&c.refreshPanels(e.data)}),"json")})),r.on("click",".ticket_duplicate",(function(e){e.preventDefault();const t=n(this),i={action:"tribe-ticket-duplicate",post_id:g.val(),ticket_id:t.data("ticketId"),nonce:TribeTickets.duplicate_ticket_nonce,is_admin:n("body").hasClass("wp-admin")};return n.post(ajaxurl,i,(function(e){e.success&&c.refreshPanels(e.data)}),"json"),!1})),r.on("change",".tribe-ticket-field-capacity",(function(e){const t=n(this),i=t.parents(".input_block").eq(0).find(".tribe-ticket-field-mode");t.val()&&i.val("capped")})),r.on("keyup","#ticket_price, #ticket_sale_price",(function(e){e.preventDefault();const t=price_format.decimal,i=new RegExp("[^-0-9%\\"+t+"]+","gi"),a=n(this).val(),c=a.replace(i,"");a!==c&&n(this).val(c)})),r.on("click","#tribe_ticket_header_image, #tribe_ticket_header_preview",(function(e){e.preventDefault(),t.uploader("","")})),r.on("focus","#settings_global_capacity_edit",(function(){const e=n(this);let t=0;n(".tribe-tickets-editor-capacity-table").find("[data-capacity]").each((function(){const e=n(this);t+=parseInt(e.data("capacity"),10)})),e.data("nonSharedCapacity",t)})),r.on("blur change","#settings_global_capacity_edit",(function(){const e=n(".tribe-tickets-editor-table-row-capacity-total");if(-1===parseInt(e.data("totalCapacity"),10))return;const t=n(this),i=e.find(".tribe-tickets-editor-total-capacity");let c=parseInt(t.val(),10);const r=t.data("nonSharedCapacity");(""===c||0>c||a.isNaN(c))&&(c=0);const o=r+c;i.text(o)})),r.on("click","#global_capacity_edit_button",(function(e){e.preventDefault(),n(document.getElementById("settings_global_capacity_edit")).prop("disabled",!1).focus()})),r.on("blur",'[name="tribe-ticket[event_capacity]"]',(function(e,t){if(void 0===t&&(t=n(this).val()),void 0===t)return;t||(t=0),t=parseInt(t,10);const i=n(".tribe-ticket-capacity-max").find(".tribe-ticket-capacity-value"),a=n('.tribe-ticket-field-capacity[name="tribe-ticket[capacity]"]');a.attr("placeholder",t),t?a.attr("max",t):t=0,i.text(t)})),r.on("change",'[name="tribe-ticket[capacity]"]',(function(e){const t=n(this),i=parseInt(t.attr("max"),10),a=parseInt(t.val(),10);i&&i<a&&t.val(i)})),p?(r.on("tribe-recurrence-active",(function(e){n(_).hide(),n(u).hide(),n(k).show()})),r.on("tribe-recurrence-inactive",(function(e){n(_).show(),n(u).show(),n(k).hide()})),r.on("tribe-tickets-active",(function(e){n(d).hide(),n(s).css("visibility","visible").show()})),r.on("tribe-tickets-inactive",(function(e){n(l).find(".tribe-recurrence-rule").length>0?n(d).show():n(".recurrence-row.tribe-datetime-block:not(.tribe-recurrence-exclusion-row)").show(),n(s).hide()}))):n(_).parent().find(".ticket-editor-notice.recurring_event_warning").hide(),r.on("click","#tribe_ticket_header_remove",(function(e){e.preventDefault(),n(document.getElementById("tribe_ticket_header_preview")).html(""),n(document.getElementById("tribe_ticket_header_remove")).hide(),n(document.getElementById("tribe_tickets_image_preview_filename")).hide().find(".filename").text(""),n(document.getElementById("tribe_ticket_header_image_id")).val("")})),r.on("after_panel_swap.tickets",(function(){r.trigger("tribe-tickets-active")})),r.on("verify.dependency",(function(){n(".tribe-tickets-editor-table-tickets-body").is(":visible")?r.trigger("tribe-tickets-active"):r.trigger("tribe-tickets-inactive"),n(l).is(":visible")?r.trigger("tribe-recurrence-active"):r.trigger("tribe-recurrence-inactive")})),n(c.setupPanels)}(window,jQuery,_,tribe.tickets.editor),window.tec=window.tec||{},window.tec.tickets=window.tec.tickets||{},window.tec.tickets.tickets={}})();